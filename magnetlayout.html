<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2x2 Magnet Layout App</title>
  <style>
    body {
      font-family: sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 20px;
    }
    :root {
      --bg: #f9f9f9;
      --fg: #000;
    }
    .dark-mode {
      --bg: #1e1e1e;
      --fg: #fff;
    }
    .container {
      max-width: 800px;
      margin: auto;
      text-align: center;
    }
    canvas {
      border: 1px solid #ccc;
      margin: 20px 0;
      cursor: move;
    }
    input[type="file"], input[type="text"] {
      margin: 10px;
    }
    button {
      margin: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>2" x 2" Magnet Designer</h1>
    <input type="file" id="imageLoader" accept="image/*" />
    <input type="text" id="brandingText" placeholder="Enter branding text" />
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <button onclick="toggleCutMarks()">Toggle Cut Marks</button>
    <canvas id="templateCanvas" width="675" height="675"></canvas>
    <button onclick="generateSheet(3,4)">Generate Full Sheet PDF</button> // generateSheet(Rows,Columns)
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const canvas = document.getElementById("templateCanvas");
    const ctx = canvas.getContext("2d");

    const bleedSize = 675;
    const trimSize = 600;
    const safeSize = 525;
    const margin = (bleedSize - trimSize) / 2;
    const safeMargin = (bleedSize - safeSize) / 2;

    let uploadedImage, brandingText = "", showCutMarks = true;
    let imageX = 0, imageY = 0, isDragging = false;

    function drawTemplate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#f0f0f0";
      ctx.fillRect(0, 0, bleedSize, bleedSize);

      if (uploadedImage) {
        ctx.drawImage(uploadedImage, imageX, imageY, bleedSize, bleedSize);
      }

      if (showCutMarks) {
        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        ctx.strokeRect(margin, margin, trimSize, trimSize);

        ctx.strokeStyle = "green";
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(safeMargin, safeMargin, safeSize, safeSize);
        ctx.setLineDash([]);
      }

      if (brandingText) {
        ctx.fillStyle = "black";
        ctx.font = "30px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(brandingText, bleedSize / 2, bleedSize - 20);
      }
    }

    document.getElementById("imageLoader").addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        uploadedImage = new Image();
        uploadedImage.onload = function () {
          drawTemplate();
        };
        uploadedImage.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    document.getElementById("brandingText").addEventListener("input", function (e) {
      brandingText = e.target.value;
      drawTemplate();
    });

    canvas.addEventListener("mousedown", (e) => {
      isDragging = true;
    });

    canvas.addEventListener("mouseup", () => {
      isDragging = false;
    });

    canvas.addEventListener("mousemove", (e) => {
      if (isDragging && uploadedImage) {
        const rect = canvas.getBoundingClientRect();
        imageX = e.clientX - rect.left - bleedSize / 2;
        imageY = e.clientY - rect.top - bleedSize / 2;
        drawTemplate();
      }
    });

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function toggleCutMarks() {
      showCutMarks = !showCutMarks;
      drawTemplate();
    }

    async function generateSheet(PerRow,PerCol) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "in", format: "letter" });
      toggleCutMarks(); // remove cutmarks before building imgData
      //const magnetsPerRow = 3;
      //const magnetsPerCol = 4;
      const magnetsPerRow = PerRow;
      const magnetsPerCol = PerCol;
	  
	    const gap = 0.1; // 0.1 inch gap between magnets
      const magnetInches = 2.25;
	    const totalSize = magnetInches + gap;
	  
      const marginLeft = (8.5 - (magnetsPerRow * totalSize)) / 2;
      const marginTop = (11 - (magnetsPerCol * totalSize)) / 2;

      const imgData = canvas.toDataURL("image/png");

      toggleCutMarks(); // toggle cutmarks to back on.
      
      for (let row = 0; row < magnetsPerCol; row++) {
        for (let col = 0; col < magnetsPerRow; col++) {
          //const x = marginLeft + col * magnetInches;
          //const y = marginTop + row * magnetInches;
          const x = marginLeft + col * totalSize;
          const y = marginTop + row * totalSize;
          doc.addImage(imgData, "PNG", x, y, magnetInches, magnetInches);
        }
      }

      doc.save("magnet_sheet.pdf");
    }

    drawTemplate();
  </script>
</body>
</html>
